; ============================================================
; HALMET Marine Engine & Tank Monitor
; PlatformIO project configuration
;
; IMPORTANT — platform:
;   SensESP v3 requires Arduino ESP32 Core 3.x (IDF 5.x).
;   The official espressif32 platform is frozen at Core 2.0.17.
;   Use the pioarduino community fork instead.
;
; IMPORTANT — NMEA2000 library name:
;   Registry name is ttlappalainen/NMEA2000-library (hyphen).
;   ttlappalainen/NMEA2000 does not exist; causes UnknownPackageError.
;
; IMPORTANT — NMEA2000_esp32:
;   Not in the PlatformIO registry.  Pull directly from GitHub.
;
; IMPORTANT — esp_websocket_client:
;   Bundled in IDF 4.x; a separate managed IDF component in IDF 5.x.
;   Must be declared with the  name=url  syntax in lib_deps (not a bare
;   URL).  This is the convention used by SensESP itself and causes
;   PlatformIO to register it as a named IDF component rather than an
;   anonymous zip download.
;
; IMPORTANT — lib_ldf_mode = deep:
;   PlatformIO's default LDF mode (chain) only scans one level of
;   #include directives — it reads your src/ files and finds the
;   libraries they include directly, but stops there.
;   SensESP, NMEA2000-library, OneWire, and DallasTemperature all have
;   headers that include further headers (sensesp.h, NMEA2000.h,
;   OneWire.h, etc.) inside the library tree itself.  Without "deep",
;   LDF never sees those transitive includes, so the headers appear
;   missing even though the libraries are installed.
;   "deep" makes LDF recurse into every header of every found library,
;   ensuring all transitive dependencies are discovered.
;
; IMPORTANT — lib_archive = no:
;   pioarduino must link library object files directly rather than
;   bundling them into static archives (.a files).  Without this,
;   the linker discards weak-symbol overrides defined in the ESP-IDF
;   framework, causing obscure link failures at the final link step.
; ============================================================

[env:halmet]
; pioarduino "stable" tag always points to the latest tested release
platform  = https://github.com/pioarduino/platform-espressif32/releases/download/stable/platform-espressif32.zip
board     = esp32dev
framework = arduino

; linting
platform_packages = platformio/tool-clangtidy@^1.190100.0 
                    platformio/tool-cppcheck@^1.260.0
                     
check_tool = clangtidy
;check_tool = cppcheck
;platform_packages = tool-cppcheck@1.260.0

monitor_speed  = 115200
upload_speed   = 921600

; HALMET has 8 MB flash — use the 8 MB partition table for larger OTA headroom
board_build.partitions = default_8MB.csv

; ---- Library Dependency Finder ----
; deep: recurse into all library headers to resolve transitive deps.
; Fixes: OneWire.h, sensesp.h, NMEA2000.h not found.
lib_ldf_mode = deep

; no: link objects directly, not as .a archives (required by pioarduino).
lib_archive = no

build_flags =
    -D ARDUINO_USB_CDC_ON_BOOT=0
    ; SensESP v3 requires the ESP-IDF logging backend
    -D USE_ESP_IDF_LOG
    -D CORE_DEBUG_LEVEL=ARDUHAL_LOG_LEVEL_WARN
    -D 'FW_VERSION_STR="1.1.0"'
    ; --- HALMET physical pin assignments ---
    -D HALMET_PIN_D1=23       ; Alternator W-terminal (RPM pulse input)
    -D HALMET_PIN_D2=25       ; Oil pressure warning  (active-low)
    -D HALMET_PIN_D3=27       ; Temperature warning   (active-low)
    -D HALMET_PIN_D4=26       ; Ignition key sense    (optional, +12V)
    -D HALMET_PIN_1WIRE=4     ; DS18B20 1-Wire bus
    -D HALMET_PIN_RELAY=32    ; Bilge fan relay output (GPIO header)
    ; --- NMEA 2000 CAN pins (HALMET fixed: TX=5, RX=4) ---
    -D ESP32_CAN_TX_PIN=GPIO_NUM_5
    -D ESP32_CAN_RX_PIN=GPIO_NUM_4

lib_deps =
    ; SensESP v3 — must be ^3.1.0 or later for pioarduino/IDF5 compatibility
    SignalK/SensESP @ ^3.1.0
    ; NMEA2000 core library — registry name has a HYPHEN, not a slash
    ttlappalainen/NMEA2000-library
    ; NMEA2000 ESP32 TWAI/CAN driver — not in registry, pull from GitHub
    https://github.com/ttlappalainen/NMEA2000_esp32.git
    ; esp_websocket_client — IDF 5.x managed component (split from SDK in IDF 5.x).
    ; name=url syntax registers it as a named IDF component (SensESP convention).
    ; object_id dbc87006 is the canonical espressif/esp_websocket_client component.
    esp_websocket_client=https://components.espressif.com/api/downloads/?object_type=component&object_id=dbc87006-9a4b-45e6-a6ab-b286174cb413
    ; 1-Wire temperature sensors via Matti's SensESP-native library.
    ; This replaces paulstoffregen/OneWire + milesburton/DallasTemperature.
    ; It uses OneWireNg underneath and integrates natively with the SensESP
    ; producer/consumer pipeline and web config UI.
    SensESP/OneWire @ ^3.0.1
    ; ADS1115 ADC
    adafruit/Adafruit ADS1X15 @ ^2.5
